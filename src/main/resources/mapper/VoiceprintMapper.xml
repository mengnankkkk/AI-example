<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.qlu.chatbot.mapper.VoiceprintMapper">

    <!-- 声纹记录结果映射 -->
    <resultMap id="VoiceprintResultMap" type="edu.qlu.chatbot.model.Voiceprint">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="iflytekGroupId" column="iflytek_group_id"/>
        <result property="iflytekFeatureId" column="iflytek_feature_id"/>
        <result property="featureInfo" column="feature_info"/>
        <result property="audioFileName" column="audio_file_name"/>
        <result property="registrationDate" column="registration_date"/>
        <result property="lastIdentifiedAt" column="last_identified_at"/>
        <result property="identificationCount" column="identification_count"/>
        <result property="isActive" column="is_active"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 包含用户信息的声纹记录结果映射 -->
    <resultMap id="VoiceprintWithUserResultMap" type="edu.qlu.chatbot.model.Voiceprint" extends="VoiceprintResultMap">
        <association property="user" javaType="edu.qlu.chatbot.model.User">
            <id property="id" column="user_id"/>
            <result property="username" column="username"/>
            <result property="email" column="email"/>
            <result property="phone" column="phone"/>
            <result property="fullName" column="user_full_name"/>
            <result property="createdAt" column="user_created_at"/>
            <result property="updatedAt" column="user_updated_at"/>
            <result property="isActive" column="user_is_active"/>
        </association>
    </resultMap>

    <!-- 基础查询字段 -->
    <sql id="Base_Column_List">
        id, user_id, iflytek_group_id, iflytek_feature_id, feature_info, 
        audio_file_name, registration_date, last_identified_at, 
        identification_count, is_active, created_at, updated_at
    </sql>

    <!-- 包含用户信息的查询字段 -->
    <sql id="Base_Column_List_With_User">
        v.id, v.user_id, v.iflytek_group_id, v.iflytek_feature_id, v.feature_info,
        v.audio_file_name, v.registration_date, v.last_identified_at,
        v.identification_count, v.is_active, v.created_at, v.updated_at,
        u.username, u.email, u.phone, 
        u.full_name as user_full_name, u.created_at as user_created_at, 
        u.updated_at as user_updated_at, u.is_active as user_is_active
    </sql>

    <!-- 根据ID查询声纹记录 -->
    <select id="findById" parameterType="long" resultMap="VoiceprintResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM voiceprints
        WHERE id = #{id}
    </select>

    <!-- 根据用户ID查询声纹记录 -->
    <select id="findByUserId" parameterType="long" resultMap="VoiceprintResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM voiceprints
        WHERE user_id = #{userId}
        ORDER BY registration_date DESC
    </select>

    <!-- 根据用户ID查询激活的声纹记录 -->
    <select id="findActiveByUserId" parameterType="long" resultMap="VoiceprintResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM voiceprints
        WHERE user_id = #{userId} AND is_active = true
        ORDER BY registration_date DESC
    </select>

    <!-- 根据讯飞特征ID查询声纹记录 -->
    <select id="findByFeatureId" parameterType="string" resultMap="VoiceprintResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM voiceprints
        WHERE iflytek_feature_id = #{featureId}
    </select>

    <!-- 根据讯飞特征ID查询声纹记录（包含用户信息） -->
    <select id="findByFeatureIdWithUser" parameterType="string" resultMap="VoiceprintWithUserResultMap">
        SELECT <include refid="Base_Column_List_With_User"/>
        FROM voiceprints v
        LEFT JOIN users u ON v.user_id = u.id
        WHERE v.iflytek_feature_id = #{featureId}
    </select>

    <!-- 根据讯飞组ID查询所有声纹记录 -->
    <select id="findByGroupId" parameterType="string" resultMap="VoiceprintResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM voiceprints
        WHERE iflytek_group_id = #{groupId}
        ORDER BY registration_date DESC
    </select>

    <!-- 查询所有激活的声纹记录 -->
    <select id="findAllActive" resultMap="VoiceprintResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM voiceprints
        WHERE is_active = true
        ORDER BY registration_date DESC
    </select>

    <!-- 查询所有声纹记录（包含用户信息） -->
    <select id="findAllWithUser" resultMap="VoiceprintWithUserResultMap">
        SELECT <include refid="Base_Column_List_With_User"/>
        FROM voiceprints v
        LEFT JOIN users u ON v.user_id = u.id
        ORDER BY v.registration_date DESC
    </select>

    <!-- 插入新的声纹记录 -->
    <insert id="insert" parameterType="edu.qlu.chatbot.model.Voiceprint" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO voiceprints (
            user_id, iflytek_group_id, iflytek_feature_id, feature_info,
            audio_file_name, registration_date, last_identified_at,
            identification_count, is_active, created_at, updated_at
        ) VALUES (
            #{userId}, #{iflytekGroupId}, #{iflytekFeatureId}, #{featureInfo},
            #{audioFileName}, 
            COALESCE(#{registrationDate}, CURRENT_TIMESTAMP),
            #{lastIdentifiedAt},
            COALESCE(#{identificationCount}, 0),
            COALESCE(#{isActive}, true),
            COALESCE(#{createdAt}, CURRENT_TIMESTAMP),
            COALESCE(#{updatedAt}, CURRENT_TIMESTAMP)
        )
    </insert>

    <!-- 更新声纹记录信息 -->
    <update id="update" parameterType="edu.qlu.chatbot.model.Voiceprint">
        UPDATE voiceprints SET
            user_id = #{userId},
            iflytek_group_id = #{iflytekGroupId},
            iflytek_feature_id = #{iflytekFeatureId},
            feature_info = #{featureInfo},
            audio_file_name = #{audioFileName},
            registration_date = #{registrationDate},
            last_identified_at = #{lastIdentifiedAt},
            identification_count = #{identificationCount},
            is_active = #{isActive},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 更新声纹记录的识别统计信息 -->
    <update id="updateIdentificationStats">
        UPDATE voiceprints SET
            last_identified_at = #{lastIdentifiedAt},
            identification_count = COALESCE(identification_count, 0) + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE iflytek_feature_id = #{featureId}
    </update>

    <!-- 软删除声纹记录 -->
    <update id="softDelete" parameterType="long">
        UPDATE voiceprints SET
            is_active = false,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 根据特征ID软删除声纹记录 -->
    <update id="softDeleteByFeatureId" parameterType="string">
        UPDATE voiceprints SET
            is_active = false,
            updated_at = CURRENT_TIMESTAMP
        WHERE iflytek_feature_id = #{featureId}
    </update>

    <!-- 物理删除声纹记录 -->
    <delete id="delete" parameterType="long">
        DELETE FROM voiceprints WHERE id = #{id}
    </delete>

    <!-- 根据特征ID物理删除声纹记录 -->
    <delete id="deleteByFeatureId" parameterType="string">
        DELETE FROM voiceprints WHERE iflytek_feature_id = #{featureId}
    </delete>

    <!-- 检查用户是否已注册声纹 -->
    <select id="existsByUserId" parameterType="long" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN true ELSE false END
        FROM voiceprints
        WHERE user_id = #{userId} AND is_active = true
    </select>

    <!-- 检查讯飞特征ID是否存在 -->
    <select id="existsByFeatureId" parameterType="string" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN true ELSE false END
        FROM voiceprints
        WHERE iflytek_feature_id = #{featureId}
    </select>

    <!-- 统计指定用户的声纹数量 -->
    <select id="countByUserId" parameterType="long" resultType="long">
        SELECT COUNT(*)
        FROM voiceprints
        WHERE user_id = #{userId}
    </select>

    <!-- 统计指定组的声纹数量 -->
    <select id="countByGroupId" parameterType="string" resultType="long">
        SELECT COUNT(*)
        FROM voiceprints
        WHERE iflytek_group_id = #{groupId}
    </select>

    <!-- 分页查询声纹记录 -->
    <select id="findWithPagination" resultMap="VoiceprintResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM voiceprints
        <where>
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <if test="groupId != null and groupId != ''">
                AND iflytek_group_id = #{groupId}
            </if>
            <if test="isActive != null">
                AND is_active = #{isActive}
            </if>
        </where>
        ORDER BY registration_date DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 统计符合条件的声纹记录数量 -->
    <select id="countWithCondition" resultType="long">
        SELECT COUNT(*)
        FROM voiceprints
        <where>
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <if test="groupId != null and groupId != ''">
                AND iflytek_group_id = #{groupId}
            </if>
            <if test="isActive != null">
                AND is_active = #{isActive}
            </if>
        </where>
    </select>

</mapper>
